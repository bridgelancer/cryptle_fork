version: 2
jobs:
  test:
    working_directory: ~/repo
    docker:
      # specify the python version
      - image: circleci/python:3.6.7
        environment:
          PYTEST_FLAGS: --junitxml=test-results/results.xml
    steps:
      - checkout
      # download and cache the virtualenv
      - restore_cache:
          keys:
            - venv-{{ .Branch }}-{{ checksum "setup.py" }}
            - venv-{{ .Branch }}-
            - venv-
      - run:
          name: Install virtualenv
          command: |
            pip install -q --user virtualenv
      - run:
          name: Actvate virtualenv and install dependencies
          command: |
            virtualenv .venv
            source .venv/bin/activate
            pip install -q .[dev]
      - save_cache:
          key: venv-{{ .Branch }}-{{ checksum "setup.py" }}
          paths:
            - ".venv"
            - "~/.local/lib/python3.6"
      - run:
          name: Run tester
          command: |
            source .venv/bin/activate
            make test
      - run:
          name: Run formatter
          command: |
            source .venv/bin/activate
            black --diff -S
      - store_test_results:
          path: test-results

workflows:
  version: 2
  test:
    jobs:
      - test
